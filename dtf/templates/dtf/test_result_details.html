{% extends 'dtf/page_with_two_sidebars.html' %}

{% load dtf.custom_filters %}

{% block containertype %}fluid{% endblock %}

{% block navigation-sidebar-content %}
    {% include "dtf/project_sidebar.html" with active_page='submissions' project=test_result.submission.project %}
{% endblock %}

{% block content-sidebar-content %}
    {% include "dtf/submission_sidebar.html" with submission=test_result.submission %}
{% endblock %}

{% block content %}

<script>

var all_data = {{ data | to_js_dict }};

function postReferenceUpdate(reference_set_id){
    var data = {
        "test_name":"{{ test_result.name }}",
        "default_source":{{ test_result.id }},
        "references":{
        }
    }

    parameterBoxes = document.getElementsByClassName("parameterBox");
    for (var i = 0; i < parameterBoxes.length; i++) {
        box = parameterBoxes[i];
        if (parameterBoxes[i].checked) {
            if (box.getAttribute("pindex") === "") {
                data["references"][box.getAttribute("id")]= {
                    "value": null
                };
            }
            else {
                data["references"][box.getAttribute("id")] = {
                    "value": all_data[box.getAttribute("pindex")]["test"]["value"]
                };
            }
        }
    }

    {% if test_reference %}
    var url = `/api/projects/{{ project.id }}/references/${reference_set_id}/tests/{{ test_reference.id }}`
    var method = "PATCH"
    {% else %}
    var url = `/api/projects/{{ project.id }}/references/${reference_set_id}/tests`
    var method = "POST"
    {% endif %}

    $.ajax({
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
        },
        type: method,
        contentType: "application/json; charset=utf-8",
        url: url,
        data: JSON.stringify(data),
        success: function(result) {
            location.reload();
        },
        error: function(result) {
            alert('error. log in console');
            console.log(result);
        }
    });
}

function updateReferences(){
    {% if reference_set %}
    // there is a reference set already
    postReferenceUpdate({{ reference_set.id }})
    {% else %}
    // there is no reference set yet so we try to create one
    var data = {
        "property_values" : {{ property_values|safe }}
    }
    var reference_set_id = null
    $.ajax({
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
        },
        type: 'POST',
        contentType: "application/json; charset=utf-8",
        url: "/api/projects/{{ project.id }}/references",
        data: JSON.stringify(data),
        success: function(result) {
            postReferenceUpdate(result.id)
        },
        error: function(result) {
            alert('error. log in console');
            console.log(result);
        }
    });
    {% endif %}
}

function toggleAllBoxes(){
    box = document.getElementById("allBox");
    parameterBoxes = document.getElementsByClassName("parameterBox");
    for (var i = 0; i < parameterBoxes.length; i++) {
        if (parameterBoxes[i].parentElement.parentElement.style.display == "none") {
            continue;
        }
        parameterBoxes[i].checked = box.checked;
    }
}

</script>

<div class="border-bottom">
    <nav class="row">
        <div class="col pt-3 pb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item" aria-current="page">
                    <a href="{% url 'project_details' test_result.submission.project.slug %}">{{ project.name }}</a>
                </li>
                <li class="breadcrumb-item" aria-current="page">
                    <a href="{% url 'project_submissions' test_result.submission.project.slug %}">Submissions</a>
                </li>
                <li class="breadcrumb-item" aria-current="page">
                    <a href="{% url 'submission_details' test_result.submission.project.slug test_result.submission.pk %}">
                    {{test_result.submission.id}}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {{ test_result.name }}
                </li>
            </ol>
        </div>
        <div class="col-md-auto mt-2 mb-2 content-sidebar-dependent">
            <button class="btn btn-outline-dark btn-sm" onclick="toggleContentSidebar()"><i class="bi bi-chevron-double-left"></i></button>
        </div>
    </nav>
</div>

<div class="bg-white pt-3 pb-1">

<div class="row">
    <div class="col">
        {% with not_successful=test_result.get_next_not_successful_test_id %}
        {% if not_successful is None %}
        <a href="#" class="btn btn-sm btn-secondary me-1 disabled">Next not successful</a>  
        {% else %}
        <a href="{% url 'test_result_details' test_result.submission.project.slug not_successful %}" class="ms-4 btn btn-sm btn-info active me-1">Next not successful</a>
        {% endif %}
        {% endwith %}
    </div>

    <div class="col-md-auto">
        <button class="btn btn-sm btn-primary btn-lg active" onclick="updateReferences()">Update selected references</button>
    </div>
</div>

<div class="mt-3 pb-1">
    {% include 'dtf/filter-box.html' with show_broken=False filter_context=test %}
</div>

</div>

<table class="table table-striped table-hover table-sm tablesorter">
    <thead>
    <tr>
        <th class="noselect fit">
            Status
        </th>
        <th class="noselect">
            Name
        </th>
        <th class="noselect">
            Result
        </th>
        <th class="noselect">
            Reference on submission
        </th>
        <th class="noselect">
            Global reference
        </th>
        <th class="noselect fit sorter-false">
            <input class="ms-2 me-2" id="allBox" type="checkbox" onclick="toggleAllBoxes()" autocomplete="off"/>
        </th>
    </tr>
    </thead>
    <tbody>
    {% for parameter in data %}
        <tr class="filtered-row">
            <td class="filter-status">
                {{ parameter.status|status_badge }}
            </td>
            <td>
                <div class="d-flex">
                    <div class="">
                        <span>{{ parameter.name }}</span>
                    </div>
                    {% if parameter.test.value is not None and parameter.test.value.type == 'duration' or parameter.test.value.type == 'integer' or parameter.test.value.type == 'float' %}
                    <div class="ms-auto">
                        <a class="btn btn-outline-dark dtf-btn-xs me-1" href="{% url 'test_measurement_history' test_result.submission.project.slug test_result.id %}?measurement_name={{ parameter.name|urlencode:"" }}"><i class="bi bi-graph-up"></i></a>
                    </div>
                    {% endif %}
                </div>
            </td>
            <td>
                {{ parameter.test|as_measurement_entry:test_result.submission.project }}
            </td>
            <td>
                {{ parameter.reference_on_submission|as_measurement_entry:test_result.submission.project }}
            </td>
            <td>
                {{ parameter.reference|as_measurement_entry:test_result.submission.project }}
            </td>
            <td>
                {% if parameter.test %}
                    <input id="{{ parameter.name }}" class="ms-2 me-2 parameterBox" type="checkbox" pindex="{{ forloop.counter0 }}" autocomplete="off"/>
                {% else %}
                    <input id="{{ parameter.name }}" class="ms-2 me-2 parameterBox" type="checkbox" pindex="" autocomplete="off"/>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}